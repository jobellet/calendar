<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My MEGA Calendar</title>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 300px; text-align: center; border: 1px solid #ddd; }
        .login-box h2 { margin-top: 0; color: #333; }
        .input-group { margin-bottom: 1rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #666; }
        .input-group input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button#login-btn { width: 100%; padding: 0.75rem; background: #d9272e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        button#login-btn:hover { background: #b01f25; }
        button#login-btn:disabled { background: #ccc; cursor: not-allowed; }
        .error-msg { color: red; margin-top: 1rem; font-size: 0.9rem; display: none; }
        
        /* Calendar Container */
        #calendar-container { flex: 1; padding: 20px; max-width: 1100px; margin: 0 auto; width: 100%; box-sizing: border-box; display: none; }
        #calendar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); height: 100%; }
        
        /* Loading Spinner */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #d9272e; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Header Info */
        #user-info { text-align: right; padding: 10px 20px; font-size: 0.9rem; color: #666; display: none; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>MEGA Calendar</h2>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 20px;">Enter your MEGA.nz credentials to sync.</p>
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="you@example.com">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="********">
            </div>
            <button id="login-btn">Login & Sync</button>
            <div class="spinner" id="loading-spinner"></div>
            <div class="error-msg" id="error-msg">Authentication failed. Check credentials.</div>
        </div>
    </div>

    <div id="user-info">Logged in as: <span id="user-email"></span> | <a href="#" onclick="location.reload()">Logout</a></div>
    <div id="calendar-container">
        <div id="calendar"></div>
    </div>

    <script type="module">
        // Import megajs from a browser-compatible CDN
        import { Storage, File } from 'https://unpkg.com/megajs@1.3.5/dist/main.browser-es.mjs';

        const CALENDAR_FILENAME = 'calendar_data.json';
        let megaStorage = null;
        let calendar = null;

        // --- DOM Elements ---
        const loginBtn = document.getElementById('login-btn');
        const spinner = document.getElementById('loading-spinner');
        const errorMsg = document.getElementById('error-msg');
        const overlay = document.getElementById('login-overlay');
        const container = document.getElementById('calendar-container');
        const userInfo = document.getElementById('user-info');

        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) return;

            setLoading(true);
            errorMsg.style.display = 'none';

            try {
                // 1. Initialize MEGA Storage
                megaStorage = new Storage({
                    email: email,
                    password: password,
                    keepalive: true
                });

                // 2. Wait for connection and handshake
                await new Promise((resolve, reject) => {
                    megaStorage.on('ready', resolve);
                    megaStorage.on('error', reject);
                });

                // 3. Login successful
                console.log('Logged into MEGA');
                document.getElementById('user-email').innerText = email;
                
                // Switch UI
                overlay.style.display = 'none';
                container.style.display = 'block';
                userInfo.style.display = 'block';

                // 4. Load Calendar Data
                await initCalendar();

            } catch (err) {
                console.error(err);
                errorMsg.innerText = "Login failed: " + (err.message || "Unknown error");
                errorMsg.style.display = 'block';
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            loginBtn.disabled = isLoading;
            loginBtn.innerText = isLoading ? 'Decryption in progress...' : 'Login & Sync';
            spinner.style.display = isLoading ? 'block' : 'none';
        }

        async function initCalendar() {
            let initialEvents = [];

            // Check if our data file exists in MEGA
            const existingFile = megaStorage.root.children.find(f => f.name === CALENDAR_FILENAME);

            if (existingFile) {
                console.log('Found existing calendar file, downloading...');
                const data = await existingFile.downloadBuffer();
                try {
                    initialEvents = JSON.parse(data.toString());
                } catch(e) {
                    console.error("Corrupt JSON", e);
                }
            } else {
                console.log('No calendar file found. A new one will be created on first save.');
            }

            // Render FullCalendar
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                selectable: true,
                events: initialEvents, // Load downloaded events
                
                // Add Event
                select: function(info) {
                    const title = prompt('Enter Event Title:');
                    if (title) {
                        calendar.addEvent({
                            title: title,
                            start: info.startStr,
                            end: info.endStr,
                            allDay: info.allDay
                        });
                        saveToMega(); // Auto-save
                    }
                    calendar.unselect();
                },

                // Edit/Delete Event
                eventClick: function(info) {
                    if (confirm(`Delete event '${info.event.title}'?`)) {
                        info.event.remove();
                        saveToMega(); // Auto-save
                    }
                },

                // Drag & Drop / Resize
                eventDrop: function(info) { saveToMega(); },
                eventResize: function(info) { saveToMega(); }
            });

            calendar.render();
            // Workaround for FullCalendar sizing in flex container
            setTimeout(() => calendar.updateSize(), 100); 
        }

        async function saveToMega() {
            if (!calendar || !megaStorage) return;

            // 1. Serialize all events
            const events = calendar.getEvents().map(e => ({
                title: e.title,
                start: e.start,
                end: e.end,
                allDay: e.allDay
            }));
            
            const jsonString = JSON.stringify(events);
            const buffer = new TextEncoder().encode(jsonString); // Convert to buffer

            // 2. Find existing file to overwrite, or upload new
            const existingFile = megaStorage.root.children.find(f => f.name === CALENDAR_FILENAME);

            // Simple visual feedback in console (or add a toast notification here)
            console.log('Syncing to MEGA...');
            
            try {
                if (existingFile) {
                    // Upload/Overwrite logic (delete old, upload new is safest with simple API usage)
                    // megajs upload usually handles overwrite if configured, but let's be explicit
                    await existingFile.delete();
                } 
                
                await megaStorage.upload(CALENDAR_FILENAME, buffer).complete;
                console.log('Sync Complete!');
            } catch (err) {
                console.error('Sync failed', err);
                alert('Failed to save to MEGA. Check console.');
            }
        }
    </script>
</body>
</html>
